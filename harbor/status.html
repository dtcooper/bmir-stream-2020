<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BMIR Streaming Status Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1/new.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    const data = __JSON_DATA__
    const pollInterval = 2500
    const failPollInterval = 10000

    function render(data) {
      for (let [id, value] of Object.entries(data)) {
        if (id == 'kickoff_time') {
          if (value == 'N/A') {
            $('#kickoff-buttons').hide()
          } else {
            $('#kickoff-buttons').show()
            let date = new Date(0)
            date.setUTCSeconds(value)
            value = date
          }
        }
        $('#' + id).text(value)
      }
    }

    function reloadData() {
      $.get('/status/data.json', function(data) {
        $('#connection-status').css('color', 'green').text('syncing')
        render(data)
        setTimeout(reloadData, pollInterval)
      }).fail(function() {
        $('#connection-status').css('color', 'red').text('problem syncing, retrying')
        setTimeout(reloadData, failPollInterval)
      })
    }

    $(function() {
      $('#password-check').submit(function(e) {
        e.preventDefault()
        $('#password-check-output').text('Checking...')
        $.post('/status/password.text', $('#password').val(), function(text) {
          $('#password-check-output').text(text)
        })
      })

      $('.kick').click(function() {
        if (confirm('Are you sure?')) {
          $('.kick').prop('disabled', true)
          $.post('/status/kick.text', "" + $(this).data('amount'), function(text) {
            alert(text)
            setTimeout(function() { $('.kick').prop('disabled', false) }, 5000)
          })
        }
      })
      render(data)
      setTimeout(reloadData, pollInterval)
    })
  </script>
</head>
<body>
  <header>
    <h1>BMIR Streaming Status Page</h1>
    <i>Current health of stream. Status: <b id="connection-status" style="color: green">syncing</b>.</i>
  </header>
  <table>
    <thead>
      <tr><th colspan="2"><center>Status</center></th></tr>
    </thead>
    <tbody>
      <tr><td>Current Stream:</td><td id="stream"></td></tr>
      <tr><td>Current DJ Name:</td><td id="dj_name"></td></tr>
      <tr><td>Current DJ Connection Time:</td><td id="conn_timedelta"></td></tr>
      <tr><td>Current DJ Kickoff Time:</td><td id="kickoff_time"></td></tr>
    </tbody>
  </table>

  <div id="kickoff-buttons" style="display: none">
    <p>
      <button style="background-color: green" class="kick" data-amount="0">
        <strong>Kick and <u>DO NOT</u> ban</strong>
      </button>
      <i>(client can immediately reconnect)</i>
    </p>
    <p>
      <button style="background-color: orange" class="kick" data-amount="60">
        <strong>Kick and <u>BAN</u> for 1 minute</strong>
      </button>
    </p>
    <p>
      <button style="background-color: orangered" class="kick" data-amount="300">
        <strong>Kick and <u>BAN</u> for 5 minutes</strong>
      </button>
    </p>
    <p>
      <button style="background-color: orangered" class="kick" data-amount="900">
        <strong>Kick and <u>BAN</u> for 15 minutes</strong>
      </button>
    </p>
    <p>
      <button style="background-color: red" class="kick" data-amount="forever">
        <strong>Kick and <u>BAN PERMANENTLY</u></strong>
      </button>
      <i>(only until next server restart)</i>
    </p>
  </div>

  <details>
    <summary>Password Check Tool</summary>
    <form id="password-check">
      <p>
        <label>Password to Check:</label>
        <input type="text" id="password">
        <button>Check</button>
      </p>
      <pre id="password-check-output">Enter a password to check.</pre>
</details>
</body>
</html>
